<html>
<head>
    <title>Html-Qrcode Demo</title>
<body>
    <div id="qr-reader" style="width:250px"></div>
    <!--span>總長度：</span><input id="qr-all-length" value="13" type="tel" /-->
    <span>判斷末N碼：</span><input id="qr-check-length" value="6" type="tel" />
    <div id="qr-reader-results"></div>
    <hr>
    <div>
        <div>
            <span>末N碼：</span><input id="check_qr_1" type="tel" />
            <span>數量：</span><input id="check_num_1" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_2" type="tel" />
            <span>數量：</span><input id="check_num_2" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_3" type="tel" />
            <span>數量：</span><input id="check_num_3" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_4" type="tel" />
            <span>數量：</span><input id="check_num_4" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_5" type="tel" />
            <span>數量：</span><input id="check_num_5" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_6" type="tel" />
            <span>數量：</span><input id="check_num_6" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_7" type="tel" />
            <span>數量：</span><input id="check_num_7" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_8" type="tel" />
            <span>數量：</span><input id="check_num_8" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_9" type="tel" />
            <span>數量：</span><input id="check_num_9" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_10" type="tel" />
            <span>數量：</span><input id="check_num_10" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_11" type="tel" />
            <span>數量：</span><input id="check_num_11" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_12" type="tel" />
            <span>數量：</span><input id="check_num_12" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_13" type="tel" />
            <span>數量：</span><input id="check_num_13" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_14" type="tel" />
            <span>數量：</span><input id="check_num_14" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_15" type="tel" />
            <span>數量：</span><input id="check_num_15" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_16" type="tel" />
            <span>數量：</span><input id="check_num_16" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_17" type="tel" />
            <span>數量：</span><input id="check_num_17" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_18" type="tel" />
            <span>數量：</span><input id="check_num_18" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_19" type="tel" />
            <span>數量：</span><input id="check_num_19" type="tel" />
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_20" type="tel" />
            <span>數量：</span><input id="check_num_20" type="tel" />
        </div>
        <br>
    </div>
</body>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    docReady(function () {
    function CheckCode(checkQrCode) {
        resultContainer.innerHTML =("checkQrCode："+checkQrCode)
        //let qrAllLength = $("#qr-all-length").value;
        let qrMinLength = $("#qr-check-length").value;
        resultContainer.innerHTML =("qrMinLength："+qrMinLength)
        //if(checkQrCode.length === qrAllLength)
        //{
            let checkQrMin = checkQrCode.substring(checkQrCode.length-qrMinLength, qrAllLength);
        resultContainer.innerHTML =("checkQrMin："+checkQrMin)
            let qrcode = "";
            let prodCount = 0;
            for(let i = 1; i <= 20; i++){
                qrcode = $("#check_qr_" + i).value;
                prodCount = parseInt($("#check_num_" + i).value);
        alert("qrcode："+qrcode)
        alert("prodCount："+prodCount)
                //if(qrcode.length === qrMinLength && prodCount > 0 && checkQrMin === qrcode)
                if(prodCount > 0 && checkQrMin === qrcode)
                {
                    $("#check_num_" + i).value = prodCount-1;
                    alert("GET!");
                    break;
                }
            }
        //}
        //else{
            //alert("總長度不對");
        //}
    }
    
        var resultContainer = document.getElementById('qr-reader-results');
        var lastResult, countResults = 0;
        function onScanSuccess(decodedText, decodedResult) {
            //if (decodedText !== lastResult) {
                //++countResults;
                //lastResult = decodedText;
                // Handle on success condition with the decoded message.
                console.log(`Scan result ${decodedText}`, decodedResult);
                resultContainer.innerHTML = "當前條碼：" + decodedText;

            let qrMinLength = document.getElementById('qr-check-length').value;
                resultContainer.innerHTML = "qrMinLength：" + qrMinLength;
            let checkQrMin = decodedText.substring(decodedText.length-qrMinLength, qrAllLength);
                resultContainer.innerHTML = "checkQrMin：" + checkQrMin;
            let qrcode = "";
            let prodCount = 0;
            for(let i = 1; i <= 20; i++){
                qrcode = document.getElementById('check_qr_' + i).value;
                prodCount = parseInt(document.getElementById('check_num_' + i).value);
        resultContainer.innerHTML = ("qrcode："+qrcode)
        resultContainer.innerHTML = ("prodCount："+prodCount)
                //if(qrcode.length === qrMinLength && prodCount > 0 && checkQrMin === qrcode)
                if(prodCount > 0 && checkQrMin === qrcode)
                {
                    document.getElementById('check_num_' + i).value = prodCount-1;
                    alert("GET!");
                    break;
                }
            }
            
                CheckCode(decodedText); 
        resultContainer.innerHTML =("CheckCode")
            //}
        }

        var html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 30, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    });
</script>
</head>
</html>
