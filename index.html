<html>
<head>
    <title>Html-Qrcode Demo</title>
<body>
    <div id="qr-reader" style="width:250px"></div>
    <span>手動CHECK：</span><input id="key-check" />
    <br>
    <!--span>總長度：</span><input id="qr-all-length" value="13" type="tel" /-->
    <span>判斷末N碼：</span><input id="qr-check-length" value="6" type="tel" />
    <div id="qr-reader-results"></div>
    <div id="results" style="color: red;"></div>
    <hr>
    <div>
        <div>
            <span>末N碼：</span><input id="check_qr_1" type="tel" />
<!--             <span>數量：</span><input id="check_num_1" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_2" type="tel" />
<!--             <span>數量：</span><input id="check_num_2" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_3" type="tel" />
<!--             <span>數量：</span><input id="check_num_3" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_4" type="tel" />
<!--             <span>數量：</span><input id="check_num_4" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_5" type="tel" />
<!--             <span>數量：</span><input id="check_num_5" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_6" type="tel" />
<!--             <span>數量：</span><input id="check_num_6" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_7" type="tel" />
<!--             <span>數量：</span><input id="check_num_7" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_8" type="tel" />
<!--             <span>數量：</span><input id="check_num_8" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_9" type="tel" />
<!--             <span>數量：</span><input id="check_num_9" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_10" type="tel" />
<!--             <span>數量：</span><input id="check_num_10" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_11" type="tel" />
<!--             <span>數量：</span><input id="check_num_11" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_12" type="tel" />
<!--             <span>數量：</span><input id="check_num_12" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_13" type="tel" />
<!--             <span>數量：</span><input id="check_num_13" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_14" type="tel" />
<!--             <span>數量：</span><input id="check_num_14" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_15" type="tel" />
<!--             <span>數量：</span><input id="check_num_15" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_16" type="tel" />
<!--             <span>數量：</span><input id="check_num_16" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_17" type="tel" />
<!--             <span>數量：</span><input id="check_num_17" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_18" type="tel" />
<!--             <span>數量：</span><input id="check_num_18" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_19" type="tel" />
<!--             <span>數量：</span><input id="check_num_19" type="tel" /> -->
        </div>
        <br>
        <div>
            <span>末N碼：</span><input id="check_qr_20" type="tel" />
<!--             <span>數量：</span><input id="check_num_20" type="tel" /> -->
        </div>
        <br>
    </div>
</body>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    docReady(function () {
    function goCheck(decodedText) {
        result.innerHTML = ("goCheck!");
        //檢查條碼
                let qrMinLength = document.getElementById('qr-check-length').value;
        result.innerHTML = (qrMinLength+"!");
                let checkQrMin = decodedText.substring(decodedText.length-qrMinLength, decodedText.length);
                let qrcode = "";
                // let prodCount = 0;
                let isCheck = false;
                for(let i = 1; i <= 20; i++){
                    qrcode = document.getElementById('check_qr_' + i).value;
                    // prodCount = parseInt(document.getElementById('check_num_' + i).value);
                    //if(qrcode.length === qrMinLength && prodCount > 0 && checkQrMin === qrcode)
        result.innerHTML = (checkQrMin+"!"+qrcode);
                    if(checkQrMin === qrcode)
                    {
                        // document.getElementById('check_num_' + i).value = prodCount-1;
                        isCheck = true;
                        lastResult = "";
                        result.innerHTML = ("GET!");
                        break;
                    }
                }
                if(!isCheck) {
                    result.innerHTML = "沒有可用的！";
                }
    }
    
        // Get the input field
        var input = document.getElementById("key-check");
        input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            goCheck(input.value);
            document.getElementById('key-check').value = ''
          }
        });
        
        var resultContainer = document.getElementById('qr-reader-results');
        var result = document.getElementById('results');
        var lastResult, countResults = 0;
        function onScanSuccess(decodedText, decodedResult) {
            if (decodedText !== lastResult) {
                ++countResults;
                lastResult = decodedText;
                // Handle on success condition with the decoded message.
                console.log(`Scan result ${decodedText}`, decodedResult);
                resultContainer.innerHTML = "當前條碼：" + decodedText;
            
                goCheck(decodedText);
            }
        }
        
        const formatsToSupport = [
  //         Html5QrcodeSupportedFormats.QR_CODE,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION,
  // Html5QrcodeSupportedFormats.AZTEC,
  // Html5QrcodeSupportedFormats.CODABAR,
  Html5QrcodeSupportedFormats.CODE_39,
  Html5QrcodeSupportedFormats.CODE_93,
  Html5QrcodeSupportedFormats.CODE_128,
  // Html5QrcodeSupportedFormats.DATA_MATRIX,
  // Html5QrcodeSupportedFormats.MAXICODE,
  Html5QrcodeSupportedFormats.ITF,
  Html5QrcodeSupportedFormats.EAN_13,
  Html5QrcodeSupportedFormats.EAN_8,
  // Html5QrcodeSupportedFormats.PDF_417,
  // Html5QrcodeSupportedFormats.RSS_14,
  // Html5QrcodeSupportedFormats.RSS_EXPANDED,
        ];
        var html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 30,
                            qrbox: { width: 250, height: 250 },
                            formatsToSupport: formatsToSupport 
                         });
        html5QrcodeScanner.render(onScanSuccess);
    });
</script>
</head>
</html>
